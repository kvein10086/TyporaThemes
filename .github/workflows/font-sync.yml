name: å­—ä½“åŒæ­¥æ›´æ–°

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥æ›´æ–°
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-font-updates:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r .github/scripts/requirements.txt
    
    - name: æ£€æŸ¥LXGWNeoZhiSongæ›´æ–°
      id: check-zhisong
      run: |
        python .github/scripts/check_font_updates.py \
          --repo lxgw/LxgwNeoZhiSong \
          --font-name "LXGWNeoZhiSongPlus.ttf" \
          --output-file .github/scripts/zhisong_latest.json
    
    - name: æ£€æŸ¥LXGWNeoXiHeiæ›´æ–°
      id: check-xihei
      run: |
        python .github/scripts/check_font_updates.py \
          --repo lxgw/LxgwNeoXiHei \
          --font-name "LXGWNeoXiHeiPlus.ttf" \
          --output-file .github/scripts/xihei_latest.json
    
    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      id: check-updates
      run: |
        # è¯»å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        if [ -f "font_versions.json" ]; then
          CURRENT_ZHISONG=$(jq -r '.zhisong.version' font_versions.json 2>/dev/null || echo "unknown")
          CURRENT_XIHEI=$(jq -r '.xihei.version' font_versions.json 2>/dev/null || echo "unknown")
        else
          CURRENT_ZHISONG="unknown"
          CURRENT_XIHEI="unknown"
        fi
        
        # è¯»å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        LATEST_ZHISONG=$(jq -r '.version' .github/scripts/zhisong_latest.json)
        LATEST_XIHEI=$(jq -r '.version' .github/scripts/xihei_latest.json)
        
        echo "å½“å‰ç‰ˆæœ¬:"
        echo "  LXGWNeoZhiSong: $CURRENT_ZHISONG"
        echo "  LXGWNeoXiHei: $CURRENT_XIHEI"
        echo "æœ€æ–°ç‰ˆæœ¬:"
        echo "  LXGWNeoZhiSong: $LATEST_ZHISONG"
        echo "  LXGWNeoXiHei: $LATEST_XIHEI"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        ZHISONG_UPDATED=false
        XIHEI_UPDATED=false
        
        if [ "$CURRENT_ZHISONG" != "$LATEST_ZHISONG" ]; then
          ZHISONG_UPDATED=true
          echo "å‘çŽ°LXGWNeoZhiSongæ›´æ–°: $CURRENT_ZHISONG -> $LATEST_ZHISONG"
        fi
        
        if [ "$CURRENT_XIHEI" != "$LATEST_XIHEI" ]; then
          XIHEI_UPDATED=true
          echo "å‘çŽ°LXGWNeoXiHeiæ›´æ–°: $CURRENT_XIHEI -> $LATEST_XIHEI"
        fi
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "zhisong_updated=$ZHISONG_UPDATED" >> $GITHUB_OUTPUT
        echo "xihei_updated=$XIHEI_UPDATED" >> $GITHUB_OUTPUT
        echo "latest_zhisong=$LATEST_ZHISONG" >> $GITHUB_OUTPUT
        echo "latest_xihei=$LATEST_XIHEI" >> $GITHUB_OUTPUT
    
    - name: ä¸‹è½½å¹¶è½¬æ¢å­—ä½“
      if: steps.check-updates.outputs.zhisong_updated == 'true' || steps.check-updates.outputs.xihei_updated == 'true'
      run: |
        mkdir -p temp_fonts
        
        # ä¸‹è½½LXGWNeoZhiSong
        if [ "${{ steps.check-updates.outputs.zhisong_updated }}" == "true" ]; then
          echo "ä¸‹è½½LXGWNeoZhiSongå­—ä½“..."
          ZHISONG_URL=$(jq -r '.font.download_url' .github/scripts/zhisong_latest.json)
          if [ "$ZHISONG_URL" != "null" ] && [ -n "$ZHISONG_URL" ]; then
            wget -O temp_fonts/LXGWNeoZhiSongPlus.ttf "$ZHISONG_URL"
          else
            echo "é”™è¯¯: æ— æ³•èŽ·å–LXGWNeoZhiSongä¸‹è½½é“¾æŽ¥"
            exit 1
          fi
        fi
        
        # ä¸‹è½½LXGWNeoXiHei
        if [ "${{ steps.check-updates.outputs.xihei_updated }}" == "true" ]; then
          echo "ä¸‹è½½LXGWNeoXiHeiå­—ä½“..."
          XIHEI_URL=$(jq -r '.font.download_url' .github/scripts/xihei_latest.json)
          if [ "$XIHEI_URL" != "null" ] && [ -n "$XIHEI_URL" ]; then
            wget -O temp_fonts/LXGWNeoXiHeiPlus.ttf "$XIHEI_URL"
          else
            echo "é”™è¯¯: æ— æ³•èŽ·å–LXGWNeoXiHeiä¸‹è½½é“¾æŽ¥"
            exit 1
          fi
        fi
        
        # è½¬æ¢ä¸ºWOFF2æ ¼å¼
        echo "è½¬æ¢å­—ä½“æ ¼å¼..."
        for font in temp_fonts/*.ttf; do
          if [ -f "$font" ]; then
            fontname=$(basename "$font" .ttf)
            echo "è½¬æ¢ $fontname.ttf ä¸º $fontname.woff2"
            python .github/scripts/convert_font.py "$font" "dissertation/font/$fontname.woff2"
          fi
        done
    
    - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      if: steps.check-updates.outputs.zhisong_updated == 'true' || steps.check-updates.outputs.xihei_updated == 'true'
      run: |
        # åˆ›å»ºæ–°çš„ç‰ˆæœ¬ä¿¡æ¯
        cat > font_versions.json << EOF
        {
          "zhisong": {
            "version": "${{ steps.check-updates.outputs.latest_zhisong }}",
            "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "https://github.com/lxgw/LxgwNeoZhiSong"
          },
          "xihei": {
            "version": "${{ steps.check-updates.outputs.latest_xihei }}",
            "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "https://github.com/lxgw/LxgwNeoXiHei"
          }
        }
        EOF
    
    - name: æäº¤æ›´æ–°
      if: steps.check-updates.outputs.zhisong_updated == 'true' || steps.check-updates.outputs.xihei_updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
        git add dissertation/font/*.woff2 font_versions.json
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          # åˆ›å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ðŸ”„ å­—ä½“åŒæ­¥æ›´æ–°"
          
          if [ "${{ steps.check-updates.outputs.zhisong_updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- LXGWNeoZhiSong: ${{ steps.check-updates.outputs.latest_zhisong }}"
          fi
          
          if [ "${{ steps.check-updates.outputs.xihei_updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- LXGWNeoXiHei: ${{ steps.check-updates.outputs.latest_xihei }}"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
        fi
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        rm -rf temp_fonts
        rm -f .github/scripts/*.json 